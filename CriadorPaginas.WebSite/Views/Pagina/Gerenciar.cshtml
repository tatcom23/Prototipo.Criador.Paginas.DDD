@model Paginas.Application.DTOs.PaginaDTO
@{
    ViewData["Title"] = "Editar Página Introdutória";
    var isPrincipal = Model.CdPai == null;
    // Assumindo que você tem uma Action 'Listar' para o botão Voltar
    var linkVoltar = Url.Action("Listar", "Pagina"); // Ajuste o Controller/Action conforme necessário
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>@ViewData["Title"]</h1>
    <a href="@linkVoltar" class="btn btn-outline-secondary">
        ← Voltar
    </a>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        <strong>Página:</strong> @Model.Titulo
    </div>
    <div class="card-body">

        <!-- Descrição e Banner principal -->
        <div class="mb-3 border rounded p-3 shadow-sm">
            <p><strong>Descrição:</strong></p>
            <div class="border rounded p-3 mb-3">
                @Html.Raw(Model.Conteudo)
            </div>

            <p><strong>URL de acesso:</strong> @Model.Url</p>
            @if (!string.IsNullOrEmpty(Model.Banner))
            {
                <p><strong>Banner principal:</strong></p>
                <img src="@Model.Banner" class="img-fluid rounded mb-2" alt="Banner da página" style="max-height:150px;" />
            }

            <div class="mt-3 d-flex gap-2 flex-wrap">
                <a asp-action="Editar" asp-route-id="@Model.Codigo" class="btn btn-sm btn-warning mx-1">Editar</a>
                <a asp-action="Excluir" asp-route-id="@Model.Codigo" class="btn btn-sm btn-danger mx-1">Excluir</a>
                <a asp-action="Exibir" asp-route-id="@Model.Url" class="btn btn-sm btn-success mx-1" target="_blank">Exibir</a>
            </div>
        </div>

        <!-- Botões de navegação da página -->
        <h5>Botões de navegação da página</h5>
        @if (Model.Botoes != null && Model.Botoes.Any())
        {
            var botoesOrdenados = Model.Botoes.OrderBy(b => b.Ordem).ToList();
            <ul class="list-unstyled">
                @for (int i = 0; i < botoesOrdenados.Count; i++)
                {
                    var botao = botoesOrdenados[i];
                    <li class="mb-2 border rounded p-2 shadow-sm d-flex justify-content-between align-items-center">
                        <div>
                            <strong>@botao.Nome</strong> &nbsp;→&nbsp;
                            <a href="@botao.Link" target="_blank">@botao.Link</a>
                            <small class="text-muted"> (Ordem: @botao.Ordem)</small>
                        </div>
                        <div class="d-flex gap-1">
                            @if (i > 0)
                            {
                                <form asp-action="AtualizarOrdem" asp-controller="Botao" method="post" class="d-inline">
                                    <input type="hidden" name="idA" value="@botao.Codigo" />
                                    <input type="hidden" name="idB" value="@botoesOrdenados[i - 1].Codigo" />
                                    <input type="hidden" name="paginaId" value="@Model.Codigo" />
                                    <button type="submit" class="btn btn-sm btn-outline-secondary mx-1">🔼</button>
                                </form>
                            }
                            @if (i < botoesOrdenados.Count - 1)
                            {
                                <form asp-action="AtualizarOrdem" asp-controller="Botao" method="post" class="d-inline">
                                    <input type="hidden" name="idA" value="@botao.Codigo" />
                                    <input type="hidden" name="idB" value="@botoesOrdenados[i + 1].Codigo" />
                                    <input type="hidden" name="paginaId" value="@Model.Codigo" />
                                    <button type="submit" class="btn btn-sm btn-outline-secondary mx-1">🔽</button>
                                </form>
                            }

                            <a asp-controller="Botao" asp-action="Editar" asp-route-id="@botao.Codigo" class="btn btn-sm btn-outline-warning mx-1">✏️</a>
                            <a asp-controller="Botao" asp-action="Excluir" asp-route-id="@botao.Codigo" class="btn btn-sm btn-outline-danger mx-1">🗑️</a>
                        </div>
                    </li>
                }
            </ul>
        }
        else
        {
            <p><em>Sem botões.</em></p>
        }

        <!-- CARROSSEIS -->
        <h5 class="mt-4">Carrossel</h5>

        @if (Model.Carrosseis?.Any() == true)
        {
            foreach (var carrossel in Model.Carrosseis)
            {
                var imagensOrdenadas = carrossel.Imagens.OrderBy(i => i.Ordem).ToList();

                <div class="card mb-3 shadow-sm">

                    <!-- Cabeçalho do carrossel -->
                    <div class="card-header bg-secondary text-white d-flex justify-content-between">
                        <strong>@carrossel.Titulo</strong>

                        <div class="d-flex gap-1">
                            <a asp-action="EditarCarrossel"
                               asp-route-id="@carrossel.Codigo"
                               class="btn btn-sm btn-warning mx-1"
                               data-bs-toggle="tooltip"
                               data-bs-title="Editar carrossel">
                                ✏️
                            </a>

                            <form asp-action="ExcluirCarrossel"
                                  asp-route-id="@carrossel.Codigo"
                                  asp-route-cdPagina="@Model.Codigo"
                                  method="post"
                                  onsubmit="return confirm('Excluir este carrossel?')">

                                <button class="btn btn-sm btn-danger mx-1"
                                        data-bs-toggle="tooltip"
                                        data-bs-title="Excluir carrossel">
                                    🗑️
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Corpo -->
                    <div class="card-body">

                        @if (imagensOrdenadas.Any())
                        {
                            <div class="row g-3">
                                @for (int i = 0; i < imagensOrdenadas.Count; i++)
                                {
                                    var img = imagensOrdenadas[i];

                                    <div class="col-6 col-md-4 col-lg-3">
                                        <div class="border rounded p-2 shadow-sm text-center h-100 d-flex flex-column">

                                            <!-- IMAGEM -->
                                            <img src="@img.UrlImagem"
                                                 class="img-fluid rounded mb-2"
                                                 style="max-height:150px; object-fit:cover;" />

                                            <!-- TÍTULO / DESCRIÇÃO -->
                                            <div class="mb-2">
                                                <strong>@img.Titulo</strong><br />
                                                <small class="text-muted">@img.Descricao</small>
                                            </div>

                                            <!-- ORDEM -->
                                            <div class="d-flex justify-content-center gap-1 mt-auto">

                                                @* Seta pra cima *@
                                                @if (i > 0)
                                                {
                                                    <form asp-controller="Pagina"
                                                          asp-action="AtualizarOrdemImagem"
                                                          method="post">

                                                        <input type="hidden" name="idA" value="@img.Codigo" />
                                                        <input type="hidden" name="idB" value="@imagensOrdenadas[i - 1].Codigo" />
                                                        <input type="hidden" name="carrosselId" value="@carrossel.Codigo" />
                                                        <input type="hidden" name="paginaId" value="@Model.Codigo" />

                                                        <button class="btn btn-sm btn-outline-secondary mx-1"
                                                                data-bs-toggle="tooltip"
                                                                data-bs-title="Mover para cima">
                                                            🔼
                                                        </button>
                                                    </form>
                                                }

                                                @* Seta pra baixo *@
                                                @if (i < imagensOrdenadas.Count - 1)
                                                {
                                                    <form asp-controller="Pagina"
                                                          asp-action="AtualizarOrdemImagem"
                                                          method="post">

                                                        <input type="hidden" name="idA" value="@img.Codigo" />
                                                        <input type="hidden" name="idB" value="@imagensOrdenadas[i + 1].Codigo" />
                                                        <input type="hidden" name="carrosselId" value="@carrossel.Codigo" />
                                                        <input type="hidden" name="paginaId" value="@Model.Codigo" />

                                                        <button class="btn btn-sm btn-outline-secondary mx-1"
                                                                data-bs-toggle="tooltip"
                                                                data-bs-title="Mover para baixo">
                                                            🔽
                                                        </button>
                                                    </form>
                                                }

                                            </div>

                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p><em>Sem imagens neste carrossel.</em></p>
                        }

                    </div>
                </div>
            }
        }
        else
        {
            <p><em>Sem carrosséis.</em></p>
        }

        <!-- Tópicos -->
        <h5 class="mt-4">Tópicos</h5>
        @if (Model.PaginaFilhos != null && Model.PaginaFilhos.Any())
        {
            var topicosOrdenados = Model.PaginaFilhos.OrderBy(t => t.Ordem).ToList();
            @for (int i = 0; i < topicosOrdenados.Count; i++)
            {
                var topico = topicosOrdenados[i];
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <h6><strong>Título do tópico:</strong> @topico.Titulo</h6>
                        <p><strong>Ordem de visualização do tópico:</strong> @topico.Ordem</p>
                        <p><strong>Descrição do tópico:</strong></p>
                        <div class="border rounded p-3 mb-2">
                            @Html.Raw(topico.Conteudo)
                        </div>

                        <div class="d-flex gap-2 mb-2 flex-wrap">
                            @if (i > 0)
                            {
                                <form asp-action="AtualizarOrdem" asp-controller="Pagina" method="post" class="d-inline">
                                    <input type="hidden" name="idA" value="@topico.Codigo" />
                                    <input type="hidden" name="idB" value="@topicosOrdenados[i - 1].Codigo" />
                                    <input type="hidden" name="paginaId" value="@Model.Codigo" />
                                    <button type="submit" class="btn btn-sm btn-outline-secondary mx-1">🔼</button>
                                </form>
                            }
                            @if (i < topicosOrdenados.Count - 1)
                            {
                                <form asp-action="AtualizarOrdem" asp-controller="Pagina" method="post" class="d-inline">
                                    <input type="hidden" name="idA" value="@topico.Codigo" />
                                    <input type="hidden" name="idB" value="@topicosOrdenados[i + 1].Codigo" />
                                    <input type="hidden" name="paginaId" value="@Model.Codigo" />
                                    <button type="submit" class="btn btn-sm btn-outline-secondary mx-1">🔽</button>
                                </form>
                            }

                            <a asp-action="Editar" asp-route-id="@topico.Codigo" class="btn btn-sm btn-warning mx-1">✏️ Editar</a>
                            <a asp-action="Excluir" asp-route-id="@topico.Codigo" class="btn btn-sm btn-danger mx-1">🗑️ Excluir</a>
                        </div>

                        <!-- Botões do tópico -->
                        <strong>Botões de navegação do tópico:</strong>
                        @if (topico.Botoes != null && topico.Botoes.Any())
                        {
                            var botoesTopicoOrdenados = topico.Botoes.OrderBy(b => b.Ordem).ToList();
                            <ul class="list-unstyled">
                                @for (int j = 0; j < botoesTopicoOrdenados.Count; j++)
                                {
                                    var b = botoesTopicoOrdenados[j];
                                    <li class="mb-1 d-flex align-items-center gap-1">
                                        <strong>@b.Nome</strong> → <a href="@b.Link" target="_blank">@b.Link</a>
                                        <small class="text-muted"> (Ordem: @b.Ordem)</small>

                                        @if (j > 0)
                                        {
                                            <form asp-action="AtualizarOrdem" asp-controller="Botao" method="post" class="d-inline">
                                                <input type="hidden" name="idA" value="@b.Codigo" />
                                                <input type="hidden" name="idB" value="@botoesTopicoOrdenados[j - 1].Codigo" />
                                                <input type="hidden" name="paginaId" value="@Model.Codigo" />
                                                <button type="submit" class="btn btn-sm btn-outline-secondary mx-1">🔼</button>
                                            </form>
                                        }
                                        @if (j < botoesTopicoOrdenados.Count - 1)
                                        {
                                            <form asp-action="AtualizarOrdem" asp-controller="Botao" method="post" class="d-inline">
                                                <input type="hidden" name="idA" value="@b.Codigo" />
                                                <input type="hidden" name="idB" value="@botoesTopicoOrdenados[j + 1].Codigo" />
                                                <input type="hidden" name="paginaId" value="@Model.Codigo" />
                                                <button type="submit" class="btn btn-sm btn-outline-secondary mx-1">🔽</button>
                                            </form>
                                        }
                                        <a asp-controller="Botao" asp-action="Editar" asp-route-id="@b.Codigo" class="btn btn-sm btn-outline-warning mx-1">✏️</a>
                                        <a asp-controller="Botao" asp-action="Excluir" asp-route-id="@b.Codigo" class="btn btn-sm btn-outline-danger mx-1">🗑️</a>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p><em>Sem botões nesse tópico.</em></p>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <p><em>Sem tópicos vinculados.</em></p>
        }

    </div>
</div>

<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
