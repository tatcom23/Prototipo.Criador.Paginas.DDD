@model Paginas.Application.DTOs.PaginaDTO
@{
    ViewData["Title"] = "Editar Página Introdutória";
    var isPrincipal = Model.CdPai == null;
    // Defina o link de retorno, ajuste a action/controller se necessário
    var linkVoltar = Url.Action("Gerenciar", new { id = Model.Codigo });
}

<h1>@ViewData["Title"]</h1>

<form asp-action="Editar" method="post" enctype="multipart/form-data">
    <input type="hidden" asp-for="Codigo" />

    <div class="mb-3">
        <label asp-for="Titulo" class="form-label"></label>
        <input asp-for="Titulo" class="form-control" />
        <span asp-validation-for="Titulo" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Conteudo" class="form-label"></label>
        <textarea id="conteudoEditor" name="Conteudo" class="form-control richtext">@Model.Conteudo</textarea>
        <span asp-validation-for="Conteudo" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Url" class="form-label"></label>
        <input asp-for="Url" class="form-control" />
    </div>

    @* Banner: somente para página principal *@
    @if (isPrincipal)
    {
        <div class="mb-3">
            <label class="form-label">Banner da Página (imagem)</label>
            <input type="file" name="BannerFile" class="form-control" />
            @if (!string.IsNullOrEmpty(Model.Banner))
            {
                <img src="@Model.Banner" class="img-fluid mt-2" style="max-height: 150px;" />
            }
        </div>
    }

    <h4 class="mt-4">Carrossel de Imagens</h4>

    <button type="button" id="btn-add-carrossel" class="btn btn-outline-primary mb-3">
        Adicionar carrossel
    </button>

    <div id="carrossel-container" class="border rounded p-3 d-none">

        <div class="mb-3">
            <label class="form-label">Título do carrossel</label>
            <input type="text" name="carrosselTitulo" class="form-control"
                   placeholder="Ex: Carrossel principal" />
        </div>

        <div class="mb-3">
            <label class="form-label">Descrição do carrossel</label>
            <textarea name="carrosselDescricao" class="form-control" rows="3"
                      placeholder="Breve descrição do carrossel (opcional)"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Imagens do carrossel</label>
            <input type="file"
                   class="form-control"
                   id="CarrosselFilesInput"
                   name="CarrosselFiles"
                   multiple
                   accept="image/*" />

            <small class="text-muted">Selecione 1 ou mais imagens (JPG, PNG, GIF...).</small>
        </div>

        <div id="carrossel-previews" class="row">
        </div>

    </div>

    @* Botões: adicionar novos botões *@
    <h4 class="mt-4">Botões</h4>
    <div id="botoes-container"></div>
    <button type="button" id="add-botao" class="btn btn-secondary">Adicionar Botão</button>

    @* Tópicos: apenas para página principal *@
    @if (isPrincipal)
    {
        <h4 class="mt-4">Tópicos</h4>
        <div id="topicos-container"></div>
        <button type="button" id="add-topico" class="btn btn-secondary">Adicionar Tópico</button>
    }

    <div class="mt-4 d-flex justify-content-end">
        <a href="@linkVoltar" class="btn btn-outline-danger me-2 mx-2">Cancelar</a>
        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
    </div>
</form>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script src="https://cdn.tiny.cloud/1/b5d8tmun1yevgtofzef4ptf15z357dx69j8y3eu7lik3tw17/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        function initEditors(selector = 'textarea.richtext') {
            tinymce.init({
                selector: `${selector}:not([data-editor-initialized="1"])`,
                language: 'pt_BR',
                height: 400,
                plugins: [
                    'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                    'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                    'insertdatetime', 'media', 'table', 'help', 'wordcount'
                ],
                toolbar: 'undo redo | blocks | ' +
                    'bold italic forecolor | alignleft aligncenter ' +
                    'alignright alignjustify | bullist numlist outdent indent | ' +
                    'removeformat | help',
                content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }',
                setup: (editor) => {
                    editor.on('init', () => {
                        editor.getElement().setAttribute('data-editor-initialized', '1');
                    });
                }
            });
        }

        // Inicializa editores
        initEditors();

        // Botões principais
        let botaoIndex = 0;
        document.getElementById('add-botao').addEventListener('click', function () {
            const container = document.getElementById('botoes-container');
            const div = document.createElement('div');
            div.classList.add("botao-bloco", "border", "p-3", "mb-3", "rounded");
            div.innerHTML = `
                <input type="hidden" name="Botoes[${botaoIndex}].Ordem" value="${botaoIndex + 1}" class="botao-ordem" />
                <label class="form-label">Nome</label>
                <input name="Botoes[${botaoIndex}].Nome" class="form-control" />
                <label class="form-label">Link</label>
                <input name="Botoes[${botaoIndex}].Link" class="form-control" />
            `;
            container.appendChild(div);
            botaoIndex++;
        });

        // Tópicos (somente se for página principal)
        const addTopicoBtn = document.getElementById('add-topico');
        if (addTopicoBtn) {
            let topicoIndex = 0;
            addTopicoBtn.addEventListener('click', function () {
                const container = document.getElementById('topicos-container');
                const idx = topicoIndex;
                const html = `
                    <div class="topico-bloco border rounded p-3 mb-3">
                        <h5>Novo Tópico</h5>
                        <input type="hidden" name="PaginaFilhos[${idx}].Ordem" value="${idx + 1}" class="topico-ordem" />
                        <label class="form-label">Título</label>
                        <input name="PaginaFilhos[${idx}].Titulo" class="form-control" />
                        <label class="form-label">Conteúdo</label>
                        <textarea id="topicoConteudo_${idx}" name="PaginaFilhos[${idx}].Conteudo" class="form-control richtext"></textarea>
                        <label class="form-label">URL</label>
                        <input name="PaginaFilhos[${idx}].Url" class="form-control" />
                        <h6 class="mt-3">Botões do Tópico</h6>
                        <div id="topico-botoes-${idx}"></div>
                        <button type="button" onclick="addBotaoTopico(${idx})" class="btn btn-sm btn-outline-primary mt-2">Adicionar Botão ao Tópico</button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
                initEditors(`#topicoConteudo_${idx}`);
                topicoIndex++;
            });

            window.addBotaoTopico = function (topicoIdx) {
                const container = document.getElementById(`topico-botoes-${topicoIdx}`);
                const bIndex = container.children.length;
                const html = `
                    <div class="mb-3 border p-2 rounded">
                        <input type="hidden" name="PaginaFilhos[${topicoIdx}].Botoes[${bIndex}].Ordem" value="${bIndex + 1}" class="botao-ordem" />
                        <label>Nome</label>
                        <input name="PaginaFilhos[${topicoIdx}].Botoes[${bIndex}].Nome" class="form-control" />
                        <label>Link</label>
                        <input name="PaginaFilhos[${topicoIdx}].Botoes[${bIndex}].Link" class="form-control" />
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            };

            // Atualiza ordem dos tópicos
            function atualizarOrdemTopicos() {
                const topicos = document.querySelectorAll('#topicos-container .topico-bloco');
                topicos.forEach((topico, index) => {
                    const inputOrdem = topico.querySelector('input.topico-ordem');
                    if (inputOrdem) inputOrdem.value = index + 1;
                });
            }

            // Atualiza ordem dos botões principais
            function atualizarOrdemBotoesPrincipais() {
                const botoes = document.querySelectorAll('#botoes-container .botao-bloco');
                botoes.forEach((botao, index) => {
                    const inputOrdem = botao.querySelector('input.botao-ordem');
                    if (inputOrdem) inputOrdem.value = index + 1;
                });
            }

            // Atualiza ordem dos botões dentro dos tópicos
            function atualizarOrdemBotoesTopicos() {
                document.querySelectorAll('#topicos-container .topico-bloco').forEach(topicoEl => {
                    const containerId = topicoEl.querySelector('[id^="topico-botoes-"]').id;
                    const botoes = document.querySelectorAll(`#${containerId} .mb-3`);
                    botoes.forEach((botao, index) => {
                        const inputOrdem = botao.querySelector('input.botao-ordem');
                        if (inputOrdem) inputOrdem.value = index + 1;
                    });
                });
            }

            // Executa antes do envio
            document.querySelector('form').addEventListener('submit', function () {
                atualizarOrdemTopicos();
                atualizarOrdemBotoesPrincipais();
                atualizarOrdemBotoesTopicos();
                tinymce.triggerSave();
            });
        } else {
            document.querySelector('form').addEventListener('submit', function () {
                tinymce.triggerSave();
            });
        }

        // CARROSSEL
        document.getElementById('btn-add-carrossel').addEventListener('click', function () {
            const carrosselContainer = document.getElementById('carrossel-container');
            // Alterna a classe d-none para mostrar/esconder o container
            carrosselContainer.classList.toggle('d-none');

            // Opcional: Altera o texto do botão para indicar a ação oposta
            if (carrosselContainer.classList.contains('d-none')) {
                this.textContent = 'Adicionar carrossel';
            } else {
                this.textContent = 'Remover carrossel (ou Ocultar)';
            }
        });
        document.getElementById('CarrosselFilesInput').addEventListener('change', function (e) {
            const container = document.getElementById('carrossel-previews');
            container.innerHTML = ''; // Limpa previews anteriores
            const files = Array.from(e.target.files); // Converte para Array para manipulação

            if (files.length > 0) {
                // Armazena os arquivos selecionados para que possamos manipular a remoção
                container.currentFiles = files;
                renderPreviews(container, files);
            } else {
                container.currentFiles = [];
            }
        });

        function renderPreviews(container, files) {
            container.innerHTML = ''; // Limpa previews

            files.forEach((file, i) => {
                // Verifica se o arquivo é válido (se foi removido, ele será null)
                if (!file) return;

                // O índice [${i}] agora reflete a posição no array de arquivos (incluindo nulos)
                // Isso é importante para manter a correspondência com os arrays de títulos e descrições no Controller
                const html = `
                    <div class="col-md-3 mb-3 image-preview-block" data-file-index="${i}">
                        <div class="card p-1">
                            <div class="position-relative">
                                <img src="${URL.createObjectURL(file)}"
                                     class="img-thumbnail mb-2"
                                     style="height: 100px; width: 100%; object-fit: cover;"
                                     alt="Prévia da Imagem ${i + 1}" />
                                <button type="button"
                                        class="remove-image-btn"
                                        style="position: absolute; top: 0; right: 0;
                                               background-color: #dc3545; border: none; border-radius: 0.25rem;
                                               padding: 0.3rem 0.6rem; cursor: pointer;"
                                        aria-label="Remover Imagem"
                                        data-file-index="${i}">
                                    <i class="bi bi-x-lg text-white" style="font-size: 0.8rem;"></i>
                                </button>
                            </div>

                            <small class="text-muted mb-2 text-truncate d-block" title="${file.name}">
                                Imagem ${i + 1} - ${file.name}
                            </small>

                            <label class="form-label small mb-0">Título</label>
                            <input type="text"
                                   name="CarrosselImagensTitulos[${i}]"
                                   class="form-control form-control-sm mb-2"
                                   placeholder="Título (opcional)"
                                   value="${file.name.split('.').slice(0, -1).join('.')}" />

                            <label class="form-label small mb-0">Descrição</label>
                            <textarea name="CarrosselImagensDescricoes[${i}]"
                                      class="form-control form-control-sm" rows="1"
                                      placeholder="Descrição (opcional)"></textarea>

                            <input type="hidden" name="CarrosselIndicesParaProcessar" value="${i}" />
                        </div>
                    </div>`;

                container.insertAdjacentHTML('beforeend', html);
            });

            // Adiciona o event listener para os botões de remoção
            container.querySelectorAll('.remove-image-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const indexToRemove = parseInt(this.getAttribute('data-file-index'));
                    removeImage(container, indexToRemove);
                });
            });
        }

        function removeImage(container, index) {
            const files = container.currentFiles;

            // Remove o arquivo do array, substituindo-o por null
            // O array principal é mantido com "buracos" (nulls) para que os índices [${i}]
            // nos outros campos (títulos, descrições) continuem mapeados corretamente.
            files[index] = null;

            // Remove o bloco de preview do DOM
            const blockToRemove = container.querySelector(`.image-preview-block[data-file-index="${index}"]`);
            if (blockToRemove) {
                blockToRemove.remove();
            }

            // Oculta os inputs de Título e Descrição removidos para não serem submetidos
            // Isso é feito para evitar que eles sejam enviados se a imagem correspondente foi removida.
            // É uma camada extra de segurança, pois o loop 'renderPreviews' já não os renderizaria.
            // Como estamos removendo o bloco inteiro, essa parte se torna mais simples.

            // No entanto, para o input de arquivo principal, precisamos recriar o FileList sem os nulos
            updateFileInput(files);
        }

        function updateFileInput(files) {
            const dataTransfer = new DataTransfer();
            files.forEach(file => {
                if (file) {
                    dataTransfer.items.add(file);
                }
            });

            const fileInput = document.getElementById('CarrosselFilesInput');
            // Atualiza o FileList do input
            fileInput.files = dataTransfer.files;

            // Se o input principal tiver sua lista de arquivos alterada, o evento 'change'
            // não é disparado automaticamente. O `renderPreviews` é mais simples:
            // ele deve ser chamado quando a lista de arquivos mudar no input, ou como no nosso caso,
            // quando o array `currentFiles` for manipulado.

            // A abordagem mais simples para lidar com o envio é:
            // 1. Manter os campos de Título e Descrição no DOM (com os índices)
            // 2. Ocultar o bloco removido (feito acima com `.remove()`)
            // 3. Apenas os arquivos do `dataTransfer.files` serão enviados no `CarrosselFiles`

            // O Controller precisará ignorar os títulos e descrições cujos índices [i]
            // não correspondem a um arquivo real enviado em `CarrosselFiles`.
            // Por isso, adicionei o campo oculto `CarrosselIndicesParaProcessar`
            // que só está presente para as imagens *não* removidas.
            // O Controller deve usar *apenas* os índices listados nesse campo para
            // buscar os títulos/descrições nos arrays `CarrosselImagensTitulos` e `CarrosselImagensDescricoes`.
        }
    </script>
}