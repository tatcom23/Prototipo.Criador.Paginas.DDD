@model Paginas.Application.DTOs.PaginaDTO

@{ ViewData["Title"] = "Editar Página Introdutória"; }

<h1>@ViewData["Title"]</h1>

<form asp-action="Editar" method="post" enctype="multipart/form-data">
    <div class="mb-3">
        <label asp-for="Titulo" class="form-label"></label>
        <input asp-for="Titulo" class="form-control" />
    </div>

    <div class="mb-3">
        <label asp-for="Conteudo" class="form-label"></label>
        <textarea asp-for="Conteudo" id="conteudoEditor" class="form-control">@Model.Conteudo</textarea>
    </div>

    <div class="mb-3">
        <label asp-for="Url" class="form-label"></label>
        <input asp-for="Url" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Banner Atual</label><br />
        @if (!string.IsNullOrWhiteSpace(Model.Banner))
        {
<a href="@Model.Banner" target="_blank">@System.IO.Path.GetFileName(Model.Banner)</a> }
            else
            {
<span class="text-muted">Nenhum banner enviado</span>}
    </div>

    <div class="mb-3">
        <label>Novo Banner</label>
        <input type="file" name="BannerFile" class="form-control" />
    </div>

    <h4>Adicionar Novos Botões</h4>
    <div id="botoes-container">
        @for (int i = 0; i < Model.Botoes.Count; i++)
        {
<div class="border p-2 mb-2 rounded">
    <label>Nome</label>
    <input name="Botoes[@i].Nome" class="form-control" value="@Model.Botoes[i].Nome" />
    <label>Link</label>
    <input name="Botoes[@i].Link" class="form-control" value="@Model.Botoes[i].Link" />
    <label>Linha</label>
    <input name="Botoes[@i].Linha" class="form-control" value="@Model.Botoes[i].Linha" />
    <label>Coluna</label>
    <input name="Botoes[@i].Coluna" class="form-control" value="@Model.Botoes[i].Coluna" />
</div>}
    </div>
    <button type="button" id="add-botao" class="btn btn-secondary">Adicionar Botão</button>

    <h4 class="mt-4">Tópicos</h4>
    <div id="topicos-container">
        @for (int i = 0; i < Model.PaginaFilhos.Count; i++)
        {
            var topico = Model.PaginaFilhos[i];
<div class="border p-3 rounded mb-3">
    <h5>Tópico @(i+1)</h5>

    <label>Título</label>
    <input name="PaginaFilhos[@i].Titulo" class="form-control" value="@topico.Titulo" />

    <label>Conteúdo</label>
    <textarea name="PaginaFilhos[@i].Conteudo" class="form-control">@topico.Conteudo</textarea>

    <label>URL</label>
    <input name="PaginaFilhos[@i].Url" class="form-control" value="@topico.Url" />

    <h6 class="mt-3">Botões do Tópico</h6>
    <div id="topico-botoes-@i">
        @for (int j = 0; j < topico.Botoes.Count; j++)
        {
            var botao = topico.Botoes[j];
<div class="border p-2 mb-2 rounded">
    <label>Nome</label>
    <input name="PaginaFilhos[@i].Botoes[@j].Nome" class="form-control" value="@botao.Nome" />
    <label>Link</label>
    <input name="PaginaFilhos[@i].Botoes[@j].Link" class="form-control" value="@botao.Link" />
    <label>Linha</label>
    <input name="PaginaFilhos[@i].Botoes[@j].Linha" class="form-control" value="@botao.Linha" />
    <label>Coluna</label>
    <input name="PaginaFilhos[@i].Botoes[@j].Coluna" class="form-control" value="@botao.Coluna" />
</div>}
    </div>
    <button type="button" onclick="addBotaoTopico(@i)" class="btn btn-sm btn-outline-primary mt-2">Adicionar Botão</button>
</div>}
    </div>

    <button type="button" id="add-topico" class="btn btn-secondary">Adicionar Tópico</button>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary me-2">Salvar Alterações</button>
        <a asp-action="Listar" class="btn btn-outline-secondary">Cancelar</a>
    </div>
</form>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script src="https://cdn.tiny.cloud/1/b5d8tmun1yevgtofzef4ptf15z357dx69j8y3eu7lik3tw17/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        // Editor principal
        tinymce.init({
            selector: '#conteudoEditor',
            language: 'pt_BR',
            height: 400,
            plugins: ['advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount'],
            toolbar: 'undo redo | blocks | bold italic forecolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
            content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }'
        });

        let botaoIndex = @Model.Botoes.Count;
        document.getElementById('add-botao').addEventListener('click', function () {
            const container = document.getElementById('botoes-container');
            const div = document.createElement('div');
            div.classList.add("border", "p-2", "mb-2", "rounded");
            div.innerHTML = `
                <label>Nome</label>
                <input name="Botoes[${botaoIndex}].Nome" class="form-control" />
                <label>Link</label>
                <input name="Botoes[${botaoIndex}].Link" class="form-control" />
                <label>Linha</label>
                <input name="Botoes[${botaoIndex}].Linha" class="form-control" />
                <label>Coluna</label>
                <input name="Botoes[${botaoIndex}].Coluna" class="form-control" />`;
            container.appendChild(div);
            botaoIndex++;
        });

        let topicoIndex = @Model.PaginaFilhos.Count;
        document.getElementById('add-topico').addEventListener('click', function () {
            const container = document.getElementById('topicos-container');
            const idx = topicoIndex;
            const html = `
                <div class="border p-3 rounded mb-3">
                    <h5>Novo Tópico</h5>
                    <label>Título</label>
                    <input name="PaginaFilhos[${idx}].Titulo" class="form-control" />
                    <label>Conteúdo</label>
                    <textarea name="PaginaFilhos[${idx}].Conteudo" class="form-control"></textarea>
                    <label>URL</label>
                    <input name="PaginaFilhos[${idx}].Url" class="form-control" />
                    <h6 class="mt-3">Botões do Tópico</h6>
                    <div id="topico-botoes-${idx}"></div>
                    <button type="button" onclick="addBotaoTopico(${idx})" class="btn btn-sm btn-outline-primary mt-2">Adicionar Botão</button>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
            topicoIndex++;
        });

        function addBotaoTopico(topicoIdx) {
            const container = document.getElementById(`topico-botoes-${topicoIdx}`);
            const bIndex = container.children.length;
            const html = `
                <div class="border p-2 mb-2 rounded">
                    <label>Nome</label>
                    <input name="PaginaFilhos[${topicoIdx}].Botoes[${bIndex}].Nome" class="form-control" />
                    <label>Link</label>
                    <input name="PaginaFilhos[${topicoIdx}].Botoes[${bIndex}].Link" class="form-control" />
                    <label>Linha</label>
                    <input name="PaginaFilhos[${topicoIdx}].Botoes[${bIndex}].Linha" class="form-control" />
                    <label>Coluna</label>
                    <input name="PaginaFilhos[${topicoIdx}].Botoes[${bIndex}].Coluna" class="form-control" />
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        document.querySelector('form').addEventListener('submit', function () {
            tinymce.triggerSave();
        });
    </script>
}
